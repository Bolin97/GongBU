<!DOCTYPE html>
<html>
<head>
    <title>Monaco ä»£ç ç”Ÿæˆå™¨</title>
    <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <style>
        :root {
            --left-width: 280px;
            --right-width: 280px;
        }

        .container {
            display: flex;
            height: 100vh;
        }
        .module-panel {
            width: var(--right-width);
            background: #f5f5f5;
            overflow-y: auto;
            padding: 10px;
        }

        /* å¯æ‹–æ‹½åˆ†å‰²æ¡ */
        .resizer {
            width: 5px;
            background: #333;
            cursor: col-resize;
            transition: background 0.2s;
        }

        .resizer:hover {
            background: #666;
        }

        /* ä¸­é—´ç¼–è¾‘å™¨ */
        #editor {
            flex: 1;
        }

        /* å·¦ä¾§æ–‡ä»¶æ ‘ */
        .file-tree {
            width: var(--left-width);
            background: #f5f5f5;
            color:  #252526;
            border-right: 1px solid #333;
            overflow-y: auto;
        }

        /* æ–‡ä»¶æ ‘æ ·å¼ */
        .tree-node {
            padding: 5px 0;
            user-select: none;
        }

        .tree-item {
            padding: 4px 20px;
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .tree-item:hover {
            background: #e0e0e0;
        }

        .tree-icon {
            margin-right: 6px;
            width: 20px;
            text-align: center;
        }
        
        /* ================== å‚æ•°å¯¹è¯æ¡†æ ·å¼ ================== */
        .param-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.4);
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
            /* è¡¨ç¤ºç½®äºæœ€ä¸Šä¸€å±‚: æ§åˆ¶ å…ƒç´ åœ¨ z è½´ä¸Šçš„å †å é¡ºåº çš„å±æ€§ */ 
            z-index: 1000;
        }

        .dialog-content {
            background: #ffffff;
            border-radius: 16px;
            box-shadow: 0 12px 24px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 500px;
            transform: scale(0.95);
            animation: dialogEnter 0.3s ease forwards;
            overflow: hidden;
        }

        @keyframes dialogEnter {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .dialog-content h3 {
            margin: 0;
            padding: 20px 24px;
            font-size: 1.4rem;
            color: #2d3748;
            border-bottom: 1px solid #e2e8f0;
        }

        #paramForm {
            padding: 20px 24px;
            padding-right: 76px;
        }

        .form-row {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
        }

        .form-row label {
            flex: 0 0 100px;
            font-size: 0.9rem;
            color: #4a5568;
            text-align: right;
            padding-right: 16px;
        }

        .form-row input,
        .form-row select {
            flex: 1;
            padding: 8px 8px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.95rem;
            transition: border-color 0.2s;
        }

        .form-row input:focus,
        .form-row select:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }

        .dialog-buttons {
            padding: 16px 24px;
            background: #f7fafc;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .dialog-buttons button {
            padding: 8px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .dialog-buttons .confirm {
            background: #4299e1;
            color: white;
        }

        .dialog-buttons .confirm:hover {
            background: #3182ce;
        }

        .dialog-buttons .cancel {
            background: #e2e8f0;
            color: #4a5568;
        }

        .dialog-buttons .cancel:hover {
            background: #cbd5e0;
        }

        /* æ¨¡å—é¢æ¿æ ·å¼ */
        .group-header {
            align-items: center; 
            padding: 6px 8px 8px 8px;
            cursor: pointer;
            background: #e0e0e0;
            border-radius: 6px;
            margin: 5px 0px;
        }

        .arrow {
            transition: transform 0.1s ease;
            transform-origin: 12px 13px;
        }

        .arrow1 {
            transition: transform 0.1s ease;
            transform-origin: 12px 12px;
        }

        .sub-modules {
            margin-left: 15px;
        }

        .sub-module {
            padding: 6px;
            margin: 4px 0;
            background: white;
            border-radius: 4px;
            cursor: move;
        }

        /* å³é”®èœå•æ ·å¼ */
        .vscode-menu {
            border: 1px solid #3c3c3c;
        }
        .menu-item .item-content {
            display: flex;
            justify-content: space-between;
            width: 100%;
        }
        .shortcut {
            color: #858585;
            margin-left: 20px;
        }
        .icon-placeholder {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            /* åº”æ›¿æ¢ä¸ºå›¾æ ‡ */
        }

        /* å³é”®èœå•ä¸­åŠŸèƒ½è¾“å…¥æ¡† */
        .vscode-prompt {
            position: fixed;
            display: none;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
            z-index: 1000;
        }

        .prompt-box {
            background: #ffffff;
            border-radius: 16px;
            box-shadow: 0 12px 24px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 500px;
            animation: dialogEnter 0.3s ease forwards;
        }

        .prompt-box h3 {
            margin: 0;
            padding: 20px 24px;
            font-size: 1.4rem;
            color: #2d3748;
            border-bottom: 1px solid #e2e8f0;
        }

        #prompt-input {
            width: calc(100% - 48px);
            margin: 20px 24px;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        #prompt-input:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }

        .button-group {
            padding: 16px 24px;
            background: #f7fafc;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .button-group button {
            padding: 8px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .button-group .confirm {
            background: #4299e1;
            color: white;
        }

        .button-group .confirm:hover {
            background: #3182ce;
        }

        .button-group .cancel {
            background: #e2e8f0;
            color: #4a5568;
        }

        .button-group .cancel:hover {
            background: #cbd5e0;
        }



    </style>
</head>
<body>
    <div class="container">
        <!-- å·¦ä¾§æ–‡ä»¶æ ‘ -->
        <div class="file-tree" id="fileTree"></div>
        <!-- å·¦ä¾§åˆ†å‰²æ¡ -->
        <div class="resizer" id="leftResizer"></div>
        <!-- ä»£ç ç¼–è¾‘å™¨ -->
        <div id="editor"></div>
        <!-- å³ä¾§åˆ†å‰²æ¡ -->
        <div class="resizer" id="rightResizer"></div>
        <!-- æ¨¡å—é¢æ¿ -->
        <div class="module-panel" id="modulePanel"></div>

        <!-- èœå•åŠŸèƒ½è¾“å…¥æ¡†  -->
        <div id="custom-prompt" class="vscode-prompt">
            <div class="dialog-content">
                <h3 id="prompt-label"></h3>
                <input type="text" id="prompt-input">
                <div class="dialog-buttons">
                    <button class="cancel" onclick="onPromptCancel()">å–æ¶ˆ</button>
                    <button class="confirm" onclick="onPromptConfirm()">ç¡®å®š</button>
                </div>
            </div>
        </div>
        
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs/loader.min.js"></script>
    <script>

        let draggedModuleId = null;
        let currentFilePath = null; // ä¿å­˜å½“å‰æ‰“å¼€çš„æ–‡ä»¶è·¯å¾„
        let currnetSelectItem = null;
        // æ·»åŠ æ–‡ä»¶å¤¹å±•å¼€çŠ¶æ€ç®¡ç†é˜Ÿåˆ—â€”â€”æ‰¹å¤„ç†
        let expandStateQueue = [];
        let stateTimer = null;

        // åŠ è½½çš„æ—¶å€™å¯åŠ¨çŠ¶æ€å®šæ—¶å™¨
        if (!stateTimer) {
            stateTimer = setInterval(flushExpandStates, 5000);
        }

        require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs' }});
        let editor;
        require(['vs/editor/editor.main'], () => {
            // åˆå§‹åŒ–ç¼–è¾‘å™¨
            editor = monaco.editor.create(document.getElementById('editor'), {
                value: '',
                language: 'python',
                minimap: { enabled: false },
                automaticLayout: true,
                scrollBeyondLastLine: false,
                theme: 'vs-dark'
            });
            // åˆå§‹åŒ–æ–‡ä»¶æ ‘
            initFileTree();
            // åŠ è½½æ¨¡å—æ•°æ®
            loadModuleGroups();
            // æ³¨å†Œæ‹–æ‹½äº‹ä»¶
            initDragAndDrop();
            // é¢æ¿å¤§å°è°ƒæ•´
            initResizers();

            // æ·»åŠ å¿«æ·é”®å‘½ä»¤ (å¿…é¡»åœ¨å›è°ƒå†…éƒ¨æ³¨å†Œ)(å› ä¸ºæ˜¯å¼‚æ­¥åŠ è½½åå›è°ƒçš„ï¼Œåœ¨å¤–é¢æ³¨å†Œå¯èƒ½å¯¼è‡´æ²¡æœ‰åŠ è½½editorï¼Œå³editor==nullæ—¶æ³¨å†Œè€ŒæŠ¥é”™)
            // ctrl + s ä¿å­˜æ–‡ä»¶
            editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyS, function() {
                const content = editor.getValue();
                saveFile(content);
            });
        });


        // é¢æ¿å¤§å°è°ƒæ•´
        function initResizers() {
            let isDragging = false;
            let startX, leftWidth, rightWidth;

            function startDrag(e) {
                isDragging = true;
                startX = e.clientX;
                leftWidth = parseFloat(getComputedStyle(document.body).getPropertyValue('--left-width')) || 280;
                rightWidth = parseFloat(getComputedStyle(document.body).getPropertyValue('--right-width')) || 300;
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
            }

            function doDrag(e) {
                if (!isDragging) return;
                
                const dx = e.clientX - startX;
                const target = e.target.id === 'leftResizer' ? 'left' : 'right';
                
                if (target === 'left') {
                    const newWidth = leftWidth + dx;
                    if (newWidth > 200 && newWidth < 600) {
                        document.documentElement.style.setProperty('--left-width', `${newWidth}px`);
                    }
                } else {
                    const newWidth = rightWidth - dx;
                    if (newWidth > 200 && newWidth < 600) {
                        document.documentElement.style.setProperty('--right-width', `${newWidth}px`);
                    }
                }
            }

            function stopDrag() {
                isDragging = false;
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
            }

            document.querySelectorAll('.resizer').forEach(resizer => {
                resizer.addEventListener('mousedown', startDrag);
            });

            document.addEventListener('mousemove', doDrag);
            document.addEventListener('mouseup', stopDrag);
        }


        // æ–‡ä»¶æ ‘æ•°æ®ç»“æ„ mockæ•°æ®
        // const fileTreeData = [
        //     {
        //         name: "src",
        //         type: "folder",
        //         expanded: true,
        //         children: [
        //             { name: "main.py", type: "file" },
        //             { name: "utils.py", type: "file" }
        //         ]
        //     },
        //     {
        //         name: "config",
        //         type: "folder",
        //         children: [
        //             { name: "settings.json", type: "file" }
        //         ]
        //     }
        // ];

        // åˆå§‹åŒ–æ–‡ä»¶æ ‘
        async function initFileTree() {
            await updateFileTree();
        }

        // æ›´æ–°æ–‡ä»¶æ ‘æ–‡ä»¶æ ‘
        async function updateFileTree() {
            // ä»åå°è·å–ç›®å½•æ ‘
            const response = await fetch(`/ide/file_tree`);
            const data = await response.json();
            fileTreeData = data[0].children;
            const container = document.getElementById('fileTree');
            // æ¸…ç©ºå­å…ƒç´ 
            container.innerHTML = '';
            renderTreeNodes(fileTreeData, container, 0, '');
        }

        // é€’å½’æ¸²æŸ“æ–‡ä»¶æ ‘
        function renderTreeNodes(nodes, parent, level = 0, currentPath='') {
            nodes.forEach(node => {
                const itemPath = currentPath ? `${currentPath}/${node.name}` : `/${node.name}`;
                const div = document.createElement('div');
                div.className = 'tree-node';
                
                const item = document.createElement('div');
                item.className = 'tree-item';
                item.style.paddingLeft = `${15 + level * 15}px`;
                
                // Arrow
                const arrow = document.createElement('div');
                arrow.className = 'arrow-wrapper';
                arrow.innerHTML = `
                    <svg class="arrow1" viewBox="0 0 21 21" width="20" height="20">
                        ${node.type === 'folder' ? `
                        <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z" />
                        ` : `
                        <path d="" fill="none"/>
                        `}
                    </svg>
                `;

                // å›¾æ ‡
                const icon = document.createElement('span');
                icon.className = 'tree-icon';
                icon.innerHTML = node.type === 'folder' ? 
                    '<i class="fa-regular fa-folder"></i>' : 
                    '<i class="fa-regular fa-file-code"></i>';
                
                // åç§°
                const name = document.createElement('span');
                name.textContent = node.name;

                item.append(arrow, icon, name);
                div.appendChild(item);

                // æ–‡ä»¶å¤¹äº¤äº’
                if (node.type === 'folder') {
                    item.addEventListener('click', () => toggleFolder(node, div, arrow, level, itemPath));
                    if (node.expanded && node.children) {
                        const childrenDiv = document.createElement('div');
                        renderTreeNodes(node.children, childrenDiv, level + 1, itemPath);
                        div.appendChild(childrenDiv);
                    }
                }
                if (node.type === 'file') {
                     // å¯¹äºæ–‡ä»¶çš„ç‚¹å‡»ï¼Œä»åå°æ¥å£ä¸­è·å–æ–‡ä»¶å†…å®¹ï¼Œä¼ å…¥æ–‡ä»¶çš„è·¯å¾„ï¼Œç„¶åæŠŠè·å–åˆ°çš„å†…å®¹æ˜¾ç¤ºåˆ°ç¼–è¾‘å™¨é‡Œé¢
                    item.addEventListener('click', () => openFile(itemPath));
                }

                // é€‰ä¸­çš„ç›®å½•æˆ–è€…æ–‡ä»¶itemèƒŒæ™¯å˜è‰²
                item.addEventListener('click', () => {
                    if(currnetSelectItem){
                        // å°†èƒŒæ™¯è‰²å˜æˆé€æ˜
                        currnetSelectItem.style.background = 'transparent';
                    }
                    item.style.background = '#094771';
                    currnetSelectItem = item;
                });

                // contextmenuäº‹ä»¶åœ¨é¼ æ ‡å³é”®æ—¶è§¦å‘
                item.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    console.log(itemPath);
                    showContextMenu(e.clientX, e.clientY, itemPath);
                });

                parent.appendChild(div);
            });
        }

        // æ–‡ä»¶çš„æ‰“å¼€
        function openFile(filePath) {
            currentFilePath = filePath;
            fetch(`/ide/file_content?path=${filePath}`)
                .then(res => res.json())
                .then(res => {
                    editor.setValue(res.content);
                });
        }

        // ä¿å­˜æ–‡ä»¶
        function saveFile(content) {
            if (!currentFilePath) {
                alert("âš ï¸ å½“å‰æœªæ‰“å¼€ä»»ä½•æ–‡ä»¶ï¼Œæ— æ³•ä¿å­˜ï¼");
                return;
            }

            fetch(`/ide/write_file`,{
                method :"POST",
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    path: currentFilePath,
                    content: content
                })
            });
        }

        // æ–‡ä»¶å¤¹å±•å¼€/æ”¶èµ·
        function toggleFolder(node, container, arrow, level, itemPath) {
            node.expanded = !node.expanded;
            // è®°å½•çŠ¶æ€å˜åŒ–ï¼Œå†™å…¥äº‹ä»¶
            pushQueueExpandState(itemPath, node.expanded);

            // æ—‹è½¬arrow
            arrow.querySelector('.arrow1').style.transform = 
                node.expanded ? 'rotate(90deg)' : 'rotate(0deg)';

            // åœ¨ container å…ƒç´ ä¸‹ï¼Œæ‰¾åˆ°å…¶æœ€åä¸€ä¸ªç›´æ¥å­ <div> å…ƒç´ (åªèƒ½æ˜¯ä¸‹ä¸€å±‚çº§divï¼Œä¸èƒ½ä¸‹ä¸‹çº§)ï¼Œå¹¶èµ‹å€¼ç»™ childrenDiv
            const childrenDiv = container.querySelector(':scope > div:last-child');
            if (node.expanded) {
                if (!childrenDiv || childrenDiv.className == 'tree-item'){
                    const newDiv = document.createElement('div');
                    renderTreeNodes(node.children, newDiv, level+1, itemPath);
                    container.appendChild(newDiv);
                }
            } else {
                childrenDiv?.remove();
            }
        }

        function handleDragStart(e) {
            draggedModuleId = e.target.dataset.moduleId;
        }

        async function loadModuleGroups() {
            // ä»åç«¯è·å–æ¨¡å—æ•°æ®
            const groups = await fetch('/api/module-groups')
                .then(res => res.json());
            // ç”Ÿæˆæ¨¡å—é¢æ¿
            const panel = document.getElementById('modulePanel');
            groups.forEach(group => createGroupElement(group, panel));
        }

        function createGroupElement(group, container) {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'module-group';
            
            // åˆ†ç»„æ ‡é¢˜
            const header = document.createElement('div');
            header.className = 'group-header';
            header.innerHTML = `
                <svg class="arrow" viewBox="-2 -2 20 20" width="20" height="20" >
                    <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
                </svg>
                ${group.name}
            `;
            
            // å­æ¨¡å—å®¹å™¨
            const subContainer = document.createElement('div');
            subContainer.className = 'sub-modules';
            subContainer.style.display = 'none';

            // ç‚¹å‡»äº‹ä»¶
            header.addEventListener('click', () => {
                const isExpanded = subContainer.style.display === 'block';
                subContainer.style.display = isExpanded ? 'none' : 'block';
                
                header.querySelector('.arrow').style.transform = 
                    isExpanded ? 'rotate(0deg)' : 'rotate(90deg)';
            });

            // ç”Ÿæˆå­æ¨¡å—
            group.modules.forEach(module => {
                const sub = document.createElement('div');
                sub.className = 'sub-module';
                sub.draggable = true;
                sub.textContent = module.name;
                sub.dataset.moduleId = module.id;
                sub.addEventListener('dragstart', handleDragStart);
                subContainer.appendChild(sub);
            });

            groupDiv.append(header, subContainer);
            container.appendChild(groupDiv);
        }
        function initDragAndDrop() {

            const editorDom = document.getElementById('editor');

            editorDom.addEventListener('dragover', (e) => {
                e.preventDefault(); // å…è®¸ drop
            });

            editorDom.addEventListener('drop', async (e) => {
                e.preventDefault();
                if (!draggedModuleId) return;
                // è·å–æ¨¡å—æ¨¡æ¿
                const module = await fetchModule(draggedModuleId);

                // è·å–å½“å‰é¼ æ ‡ä½ç½®å¯¹åº”çš„ä»£ç ä½ç½®
                const editorCoords = editor.getScrolledVisiblePosition(editor.getPosition());
                const rect = editorDom.getBoundingClientRect();

                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                const position = editor.getModel().getPositionAt(editor.getModel().getOffsetAt(editor.getPosition()));

                // è·å–å‚æ•°
                const params = await showParamDialog(module.parameters);
                if (!params) return;

                const code = generateCode(module.template, params);

                // æ’å…¥ä»£ç 
                editor.executeEdits('', [{
                    range: new monaco.Range(
                        position.lineNumber,
                        position.column,
                        position.lineNumber,
                        position.column
                    ),
                    text: code,
                    forceMoveMarkers: true
                }]);

                // ç§»åŠ¨å…‰æ ‡
                // è¿™é‡Œå¥½åƒå­˜åœ¨ä¸€äº›é—®é¢˜
                editor.setPosition({
                    lineNumber: position.lineNumber,
                    column: position.column + code.length
                });

                draggedModuleId = null;
            });
        }

        async function fetchModule(moduleId) {
            return fetch(`/api/modules/${moduleId}`)
                .then(res => res.json());
        }

        function generateCode(template, params) {
            return template.replace(/\{\{(\w+)\}\}/g, (_, key) => {
                return params[key] || '';
            });
        }

        // å³é”®èœå•åŠŸèƒ½æ¡†ä¸­å¼¹çª—
        let promptResolve;
        // ä¿®æ”¹åçš„showPrompt
        async function showPrompt(title, defaultValue = '') {
            return new Promise((resolve) => {
                const modal = document.getElementById('custom-prompt');
                document.getElementById('prompt-label').textContent = title;
                const input = document.getElementById('prompt-input');
                input.value = defaultValue;
                modal.style.display = 'flex';
                input.focus();
                
                promptResolve = (value) => {
                    modal.style.display = 'none';
                    resolve(value?.trim());
                };
            });
        }

        function onPromptConfirm() {
            const value = document.getElementById('prompt-input').value;
            promptResolve(value);
        }

        function onPromptCancel() {
            promptResolve(null);
        }

        // æ·»åŠ ESCæ”¯æŒ
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('custom-prompt').style.display === 'flex') {
                promptResolve(null);
            }
        });


        // æ–‡ä»¶å¤¹å±•å¼€çŠ¶æ€ç®¡ç†
        function pushQueueExpandState(path, isExpanded) {
            expandStateQueue.push({
                path: path,
                is_expanded: isExpanded
            });
            
            // è¾¾åˆ°3ä¸ªç«‹å³å‘é€
            if (expandStateQueue.length >= 5) {
                flushExpandStates();
                return;
            }
            
        }

        // å‘é€çŠ¶æ€æ›´æ–°
        async function flushExpandStates() {
            if (expandStateQueue.length === 0) return;
            
            // å¤åˆ¶ expandStateQueue æ•°ç»„çš„æ‰€æœ‰å…ƒç´ ï¼Œç”Ÿæˆä¸€ä¸ªæ–°çš„æ•°ç»„ statesToSend
            // ... è¡¨ç¤ºæŠŠæ¯ä¸€é¡¹æ‹†å¼€
            const statesToSend = [...expandStateQueue];
            expandStateQueue = [];
            
            if (stateTimer) {
                // æ—¶é—´é‡ç½®
                clearTimeout(stateTimer);
                stateTimer = setInterval(flushExpandStates, 5000);
            }
            
            try {
                await callApi('/ide/update_expand_states', 'POST', {
                    states: statesToSend
                });
            } catch (error) {
                console.error('ä¿å­˜å±•å¼€çŠ¶æ€å¤±è´¥:', error);
            }
        }


        // å·¥å…·å‡½æ•°
        async function callApi(endpoint, method = 'GET', body = null) {
            const headers = { 'Content-Type': 'application/json' };
            const response = await fetch(`${endpoint}`, {
                method,
                headers,
                body: body ? JSON.stringify(body) : null
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'è¯·æ±‚å¤±è´¥');
            }
            
            return response.json();
        }

        // å®ç°èœå•æ å››ä¸ªæ ¸å¿ƒåŠŸèƒ½
        async function createNewFile(path) {
            try {
                await flushExpandStates();
                const fileName = await showPrompt('è¾“å…¥æ–°æ–‡ä»¶å');
                if (!fileName) return;

                await callApi('/ide/create_item', 'POST', {
                    name: fileName,
                    type: "file",
                    path: path
                });

                await  updateFileTree();
                // alert('æ–‡ä»¶åˆ›å»ºæˆåŠŸ');
            } catch (error) {
                alert(`æ–‡ä»¶åˆ›å»ºå¤±è´¥: ${error.message}`);
            }
        }

        async function createNewFolder(path) {
            try {
                await flushExpandStates();
                const folderName = await showPrompt('è¾“å…¥æ–°æ–‡ä»¶å¤¹å');
                if (!folderName) return;

                await callApi('/ide/create_item', 'POST', {
                    name: folderName,
                    type: "folder",
                    path: path
                });

                await  updateFileTree();
                // alert('æ–‡ä»¶å¤¹åˆ›å»ºæˆåŠŸ');
            } catch (error) {
                alert(`æ–‡ä»¶å¤¹åˆ›å»ºå¤±è´¥: ${error.message}`);
            }
        }

        async function renameItem(path) {
            try {
                await flushExpandStates();
                const newName = await showPrompt('è¾“å…¥æ–°åç§°', path.split('/').pop());
                if (!newName) return;

                await callApi('/ide/rename_item', 'POST', {
                    path: path,
                    new_name: newName
                });

                await updateFileTree();
                // alert('é‡å‘½åæˆåŠŸ');
            } catch (error) {
                alert(`é‡å‘½åå¤±è´¥: ${error.message}`);
            }
        }

        async function deleteItem(path) {
            try {
                await flushExpandStates();
                if (!confirm('ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ')) return;
                
                await callApi('/ide/delete_item', 'POST', {
                    path: path
                });

                await  updateFileTree();
                // alert('åˆ é™¤æˆåŠŸ');
            } catch (error) {
                alert(`åˆ é™¤å¤±è´¥: ${error.message}`);
            }
        }

        function showContextMenu(x, y, path) {
            // ç§»é™¤å·²å­˜åœ¨çš„èœå•
            const existingMenu = document.querySelector('.vscode-menu');
            if (existingMenu) existingMenu.remove();

            // åˆ›å»ºèœå•å®¹å™¨
            const menu = document.createElement('div');
            menu.className = 'vscode-menu';
            menu.style = `
                position: fixed;
                left: ${x}px;
                top: ${y}px;
                background: #252526;
                border-radius: 4px;
                padding: 5px 0;
                min-width: 180px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                font-family: 'Segoe UI', sans-serif;
                font-size: 13px;
                color: #cccccc;
                z-index: 1000;
            `;

            // èœå•é¡¹é…ç½®ï¼ˆåŒ…å«å›¾æ ‡å ä½ç¬¦ï¼‰
            const items = [
                { name: 'æ–°å»ºæ–‡ä»¶', action: createNewFile },
                { name: 'æ–°å»ºæ–‡ä»¶å¤¹', action: createNewFolder },
                { type: 'separator' }, // åˆ†éš”çº¿
                { name: 'é‡å‘½å', action: renameItem },
                { name: 'åˆ é™¤', action: deleteItem },
                // { type: 'separator' },
                // // åç»­å¯ä»¥æ”¯æŒé›†æˆç»ˆç«¯
                // { 
                //     name: 'åœ¨é›†æˆç»ˆç«¯ä¸­æ‰“å¼€', 
                //     action: openInTerminal,
                //     shortcut: 'Ctrl+`' // æ·»åŠ å¿«æ·é”®æ˜¾ç¤º
                // }
            ];

            // æ„å»ºèœå•é¡¹
            items.forEach(item => {
                if (item.type === 'separator') {
                    const separator = document.createElement('div');
                    separator.style = `
                        height: 1px;
                        background: #3c3c3c;
                        margin: 4px 0;
                    `;
                    menu.appendChild(separator);
                } else {
                    const menuItem = document.createElement('div');
                    menuItem.className = 'menu-item';
                    menuItem.innerHTML = `
                        <span class="icon-placeholder"></span>
                        <div class="item-content">
                            <span>${item.name}</span>
                            ${item.shortcut ? `<span class="shortcut">${item.shortcut}</span>` : ''}
                        </div>
                    `;
                    menuItem.style = `
                        padding: 6px 20px;
                        display: flex;
                        align-items: center;
                        cursor: default;
                        transition: background 0.2s;
                    `;
                    menuItem.onclick = () => {
                        item.action(path);
                        menu.remove();
                    };
                    // æ‚¬åœæ•ˆæœ
                    menuItem.addEventListener('mouseenter', () => {
                        menuItem.style.background = '#007ACC';
                    });
                    menuItem.addEventListener('mouseleave', () => {
                        menuItem.style.background = 'transparent';
                    });
                    menu.appendChild(menuItem);
                }
            });

            document.body.appendChild(menu);

            // ç‚¹å‡»å¤–éƒ¨å…³é—­èœå•
            document.addEventListener('click', (e) => {
                if (!menu.contains(e.target)) menu.remove();
            }, { once: true });
        }


        function showParamDialog(params) {
            return new Promise(resolve => {
                const dialog = document.createElement('div');
                dialog.className = 'param-dialog';

                dialog.innerHTML = `
                <div class="dialog-content">
                    <h3>ğŸ”§ æ¨¡å—å‚æ•°é…ç½®</h3>
                    <form id="paramForm"></form>
                    <div class="dialog-buttons">
                        <button type="button" class="cancel">å–æ¶ˆ</button>
                        <button type="submit" class="confirm">ç”Ÿæˆä»£ç </button>
                    </div>
                </div>
                `;

                const form = dialog.querySelector('#paramForm');
                Object.entries(params).forEach(([name, config]) => {
                    const row = document.createElement('div');
                    row.className = 'form-row';

                    const label = document.createElement('label');
                    label.textContent = name;
                    label.title = config.description || '';

                    let input;

                    if (config.options) {
                        input = document.createElement('select');
                        input.name = name;
                        config.options.forEach(opt => {
                            const option = document.createElement('option');
                            option.value = opt;
                            option.textContent = opt;
                            if (opt === config.default) option.selected = true;
                            input.appendChild(option);
                        });
                    } else {
                        input = document.createElement('input');
                        input.name = name;

                        // è®¾ç½®ç±»å‹
                        if (config.type === 'int' || config.type === 'float') {
                            input.type = 'number';

                            // é™åˆ¶ min/maxï¼ˆå¦‚æœæœ‰ï¼‰
                            if ('min' in config) input.min = config.min;
                            if ('max' in config) input.max = config.max;

                            // å°æ•°ä½æ§åˆ¶
                            if (config.type === 'float') input.step = 'any'; // å…è®¸æµ®ç‚¹æ•°
                            else input.step = '1'; // int
                        } else {
                            input.type = 'text';
                        }

                        input.placeholder = config.placeholder || '';
                        if (config.default !== undefined) input.value = config.default;
                    }

                    row.append(label, input);
                    form.appendChild(row);
                });

                const confirmBtn = dialog.querySelector('.confirm');
                const cancelBtn = dialog.querySelector('.cancel');

                confirmBtn.addEventListener('click', e => {
                    e.preventDefault();
                    const formData = new FormData(form);
                    const entries = Object.fromEntries(formData);
                    let valid = true;

                    // æ‰‹åŠ¨æ ¡éªŒæ‰€æœ‰å­—æ®µï¼ˆæ¯”å¦‚æ˜¯å¦ä¸ºç©ºï¼Œæ˜¯å¦è¶…å‡ºèŒƒå›´ï¼‰
                    for (const [name, config] of Object.entries(params)) {
                        const value = entries[name];
                        if (value === '' || value === undefined) {
                            alert(`å‚æ•° ${name} ä¸ºå¿…å¡«é¡¹`);
                            valid = false;
                            continue;
                        }

                        if (config.type === 'int') {
                            // å¦‚æœå­—ç¬¦ä¸²å®Œå…¨æ— æ³•è§£æï¼ˆå¦‚ "abc"ï¼‰ï¼Œä¼šè¿”å› NaN
                            // intRegexæ¥æµ‹è¯•æ˜¯å¦ä¸ºæ•´æ•°ï¼Œè€Œä¸æ˜¯æµ®ç‚¹æ•°ç­‰ç­‰
                            const intRegex = /^-?\d+$/;
                            isIntValid = intRegex.test(value);
                            const intVal = parseInt(value);
                            if (isNaN(intVal)|| !isIntValid) {
                                alert(`${name} å¿…é¡»æ˜¯æ•´æ•°`);
                                form.querySelector(`[name="${name}"]`).value = '';
                                valid = false;
                            }
                            if ('min' in config && intVal < config.min) {
                                alert(`${name} å¿…é¡»å¤§äºç­‰äº ${config.min}`);
                                form.querySelector(`[name="${name}"]`).value = '';
                                valid = false;
                            }
                            if ('max' in config && intVal > config.max) {
                                alert(`${name} å¿…é¡»å°äºç­‰äº ${config.max}`);
                                form.querySelector(`[name="${name}"]`).value = '';
                                valid = false;
                            }
                        }

                        if (config.type === 'float') {
                            const floatRegex = /^-?\d+(\.\d+)?([eE][+-]?\d+)?$/;
                            isFloatValid = floatRegex.test(value);
                            const floatVal = parseFloat(value);
                            if (isNaN(floatVal)|| !isFloatValid ) {
                                alert(`${name} å¿…é¡»æ˜¯æµ®ç‚¹æ•°`);
                                form.querySelector(`[name="${name}"]`).value = '';
                                valid = false;
                            }
                            if ('min' in config && floatVal < config.min) {
                                alert(`${name} å¿…é¡»å¤§äºç­‰äº ${config.min}`);
                                form.querySelector(`[name="${name}"]`).value = '';
                                valid = false;
                            }
                            if ('max' in config && floatVal > config.max) {
                                alert(`${name} å¿…é¡»å°äºç­‰äº ${config.max}`);
                                form.querySelector(`[name="${name}"]`).value = '';
                                valid = false;
                            }
                        }
                    }

                    if (!valid) return; // é˜»æ­¢æäº¤

                    dialog.remove();
                    resolve(entries);
                });

                cancelBtn.addEventListener('click', () => {
                    dialog.remove();
                    resolve(null);
                });

                dialog.addEventListener('click', (e) => {
                    if (e.target === dialog) {
                        dialog.remove();
                        resolve(null);
                    }
                });

                document.body.appendChild(dialog);
            });
        }

        // åœ¨å…¨å±€æ·»åŠ é¡µé¢å…³é—­ç›‘å¬
        window.addEventListener('beforeunload', (event) => {
            // åŒæ­¥å‘é€å‰©ä½™çŠ¶æ€
            if (expandStateQueue.length > 0) {
                // å¼‚æ­¥å‘é€postè¯·æ±‚ï¼Œä¸æ¥å—è¿”å›æ•°æ®/
                navigator.sendBeacon(
                    '/ide/update_expand_states', 
                    JSON.stringify({ states: expandStateQueue })
                );
            }
        });

    </script>
</body>
</html>